# Relat√≥rio de Refatora√ß√£o: M√©tricas Gerais

## üìã Resumo Executivo

Este relat√≥rio detalha o processo de refatora√ß√£o da l√≥gica de **m√©tricas gerais**, seguindo o mesmo padr√£o implementado com sucesso para o **ranking de t√©cnicos**. O objetivo √© extrair a l√≥gica de neg√≥cios do endpoint `/metrics-gerais` para um m√≥dulo dedicado, melhorando a organiza√ß√£o, manutenibilidade e testabilidade do c√≥digo.

---

## üéØ Objetivo da Refatora√ß√£o

### Situa√ß√£o Atual
- L√≥gica de m√©tricas gerais implementada diretamente no endpoint `/metrics-gerais` do `backend.py`
- C√≥digo misturado com l√≥gica de API (viola√ß√£o do princ√≠pio de responsabilidade √∫nica)
- Dificuldade para testes unit√°rios e reutiliza√ß√£o

### Situa√ß√£o Desejada
- L√≥gica de neg√≥cios extra√≠da para m√≥dulo `logic/metrics_logic.py`
- Endpoint `/metrics-gerais` apenas chama a fun√ß√£o do m√≥dulo
- C√≥digo organizado, test√°vel e reutiliz√°vel
- Padr√£o consistente com `ranking_logic.py`

---

## üìä An√°lise da Implementa√ß√£o Atual

### Localiza√ß√£o do C√≥digo Atual
**Arquivo:** `backend/backend.py` (linhas 185-208)

### L√≥gica Atual das M√©tricas Gerais
```python
@app.get("/metrics-gerais")
def get_metrics_gerais():
    """
    M√©tricas gerais: total de tickets, novos e fechados.
    Otimizado para usar apenas totalcount sem baixar dados.
    """
    try:
        headers = glpi_client.authenticate(API_URL, APP_TOKEN, USER_TOKEN)
        
        # Total de tickets - usando fun√ß√£o otimizada
        total_tickets = get_count_only(headers)
        
        # Tickets novos (status=1) - apenas totalcount
        criteria_novos = [{"field": "12", "searchtype": "equals", "value": "1"}]
        count_novos = get_count_only(headers, criteria_novos)
        
        # Tickets fechados (status=6) - apenas totalcount
        criteria_fechados = [{"field": "12", "searchtype": "equals", "value": "6"}]
        count_fechados = get_count_only(headers, criteria_fechados)
        
        return {
            "total_tickets": total_tickets,
            "tickets_novos": count_novos,
            "tickets_fechados": count_fechados
        }
        
    except Exception as e:
        print(f"Erro em /metrics-gerais: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))
```

### Fun√ß√£o Auxiliar Utilizada
**Arquivo:** `backend/backend.py` (linhas 24-42)

```python
def get_count_only(headers, criteria=None):
    """Busca apenas o totalcount sem baixar dados."""
    import requests
    
    search_url = f"{API_URL}/search/Ticket"
    params = {
        'uid_cols': '1',
        'forcedisplay[0]': 'Ticket.id',
        'range': '0-0'  # Range m√≠nimo para obter apenas totalcount
    }
    
    if criteria:
        for i, c in enumerate(criteria):
            for k, v in c.items():
                params[f'criteria[{i}][{k}]'] = v
    
    response = requests.get(search_url, headers=headers, params=params)
    response.raise_for_status()
    data = response.json()
    
    return data.get('totalcount', 0)
```

---

## üèóÔ∏è Plano de Refatora√ß√£o

### 1. Criar M√≥dulo `logic/metrics_logic.py`

**Estrutura do novo arquivo:**

```python
"""
M√≥dulo de l√≥gica de neg√≥cios para gera√ß√£o de m√©tricas gerais do GLPI.
Implementa√ß√£o otimizada usando apenas totalcount para performance.
"""

import requests
from typing import Dict, Any

# Importa as fun√ß√µes robustas do cliente GLPI
from glpi_client import authenticate

# -- CONFIGURA√á√ïES --
API_URL = "http://cau.ppiratini.intra.rs.gov.br/glpi/apirest.php"
APP_TOKEN = "aY3f9F5aNHJmY8op0vTE4koguiPwpEYANp1JULid"
USER_TOKEN = "TQdSxqg2e56PfF8ZJSX3iEJ1wCpHwhCkQJ2QtRnq"


def get_count_only(headers: Dict[str, str], api_url: str, criteria=None) -> int:
    """
    Busca apenas o totalcount sem baixar dados para otimizar performance.
    
    Args:
        headers: Headers com session-token
        api_url: URL base da API GLPI
        criteria: Crit√©rios de filtro (opcional)
        
    Returns:
        int: N√∫mero total de registros que atendem aos crit√©rios
    """
    search_url = f"{api_url}/search/Ticket"
    params = {
        'uid_cols': '1',
        'forcedisplay[0]': 'Ticket.id',
        'range': '0-0'  # Range m√≠nimo para obter apenas totalcount
    }
    
    if criteria:
        for i, c in enumerate(criteria):
            for k, v in c.items():
                params[f'criteria[{i}][{k}]'] = v
    
    response = requests.get(search_url, headers=headers, params=params)
    response.raise_for_status()
    data = response.json()
    
    return data.get('totalcount', 0)


def generate_general_metrics() -> Dict[str, Any]:
    """
    Gera as m√©tricas gerais do sistema GLPI.
    
    Returns:
        Dict[str, Any]: Dicion√°rio com as m√©tricas:
        {
            "total_tickets": int,
            "tickets_novos": int,
            "tickets_fechados": int
        }
    """
    try:
        # Autentica√ß√£o usando o cliente GLPI robusto
        session_headers = authenticate(API_URL, APP_TOKEN, USER_TOKEN)

        # 1. Total de tickets (sem filtros)
        total_tickets = get_count_only(session_headers, API_URL)
        
        # 2. Tickets novos (status=1)
        criteria_novos = [{"field": "12", "searchtype": "equals", "value": "1"}]
        count_novos = get_count_only(session_headers, API_URL, criteria_novos)
        
        # 3. Tickets fechados (status=6)
        criteria_fechados = [{"field": "12", "searchtype": "equals", "value": "6"}]
        count_fechados = get_count_only(session_headers, API_URL, criteria_fechados)
        
        return {
            "total_tickets": total_tickets,
            "tickets_novos": count_novos,
            "tickets_fechados": count_fechados
        }
        
    except Exception as e:
        print(f"‚ùå Erro ao gerar m√©tricas gerais: {e}")
        return {
            "total_tickets": 0,
            "tickets_novos": 0,
            "tickets_fechados": 0
        }
```

### 2. Modificar o Endpoint no `backend.py`

**Altera√ß√µes necess√°rias:**

#### 2.1. Adicionar Import
```python
# No topo do arquivo backend.py, adicionar:
from logic.metrics_logic import generate_general_metrics
```

#### 2.2. Simplificar o Endpoint
```python
@app.get("/metrics-gerais")
def get_metrics_gerais():
    """
    M√©tricas gerais: total de tickets, novos e fechados.
    Utiliza a l√≥gica correta e validada do m√≥dulo metrics_logic.
    """
    try:
        metrics_data = generate_general_metrics()
        return metrics_data
        
    except Exception as e:
        print(f"‚ùå Erro em get_metrics_gerais: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

#### 2.3. Remover C√≥digo Obsoleto
- Remover a fun√ß√£o `get_count_only` (linhas 24-42)
- Remover a fun√ß√£o `get_total_tickets_count` (linhas 45-51)

---

## üìù Mudan√ßas Detalhadas

### Arquivos a Serem Criados

#### 1. `backend/logic/metrics_logic.py`
- **Novo arquivo** contendo toda a l√≥gica de m√©tricas gerais
- Fun√ß√£o principal: `generate_general_metrics()`
- Fun√ß√£o auxiliar: `get_count_only()`
- Configura√ß√µes e imports necess√°rios

### Arquivos a Serem Modificados

#### 1. `backend/backend.py`
**Linhas a serem alteradas:**

- **Linha ~10:** Adicionar import
  ```python
  from logic.metrics_logic import generate_general_metrics
  ```

- **Linhas 24-42:** Remover fun√ß√£o `get_count_only`
- **Linhas 45-51:** Remover fun√ß√£o `get_total_tickets_count`
- **Linhas 185-208:** Substituir endpoint completo por vers√£o simplificada

**Estado final do endpoint:**
```python
@app.get("/metrics-gerais")
def get_metrics_gerais():
    """
    M√©tricas gerais: total de tickets, novos e fechados.
    Utiliza a l√≥gica correta e validada do m√≥dulo metrics_logic.
    """
    try:
        metrics_data = generate_general_metrics()
        return metrics_data
        
    except Exception as e:
        print(f"‚ùå Erro em get_metrics_gerais: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

---

## üîç Valida√ß√µes Necess√°rias

### 1. Valida√ß√£o de Funcionalidade

#### 1.1. Teste do M√≥dulo Isolado
```bash
# Criar script de teste
python -c "
from backend.logic.metrics_logic import generate_general_metrics
import json
result = generate_general_metrics()
print('M√©tricas Gerais:')
print(json.dumps(result, indent=2))
"
```

**Resultado esperado:**
```json
{
  "total_tickets": 10396,
  "tickets_novos": 5,
  "tickets_fechados": 6891
}
```

#### 1.2. Teste do Endpoint Refatorado
```bash
# Testar endpoint via curl
curl -X GET "http://localhost:8000/metrics-gerais" -H "accept: application/json"
```

**Resultado esperado:** Mesmo JSON do teste anterior

#### 1.3. Teste de Performance
```bash
# Medir tempo de resposta
time curl -X GET "http://localhost:8000/metrics-gerais"
```

**Resultado esperado:** Tempo similar ao atual (2-4 segundos)

### 2. Valida√ß√£o de Integra√ß√£o

#### 2.1. Teste do Dashboard
- Abrir dashboard em `http://localhost:8050`
- Verificar se m√©tricas carregam automaticamente
- Confirmar valores corretos nos cards superiores

#### 2.2. Teste de Navega√ß√£o
- Navegar entre p√°ginas do dashboard
- Usar bot√£o "voltar" do navegador
- Verificar se m√©tricas permanecem consistentes

### 3. Valida√ß√£o de Erro

#### 3.1. Teste com Backend Indispon√≠vel
```bash
# Parar backend temporariamente
# Verificar se dashboard mostra valores zerados sem quebrar
```

#### 3.2. Teste com GLPI Indispon√≠vel
- Simular falha na conex√£o GLPI
- Verificar se retorna valores zerados
- Confirmar que n√£o h√° exce√ß√µes n√£o tratadas

---

## üìä Compara√ß√£o: Antes vs Depois

### Antes da Refatora√ß√£o

**Estrutura:**
```
backend/
‚îú‚îÄ‚îÄ backend.py (323 linhas)
‚îÇ   ‚îú‚îÄ‚îÄ get_count_only()           # L√≥gica de neg√≥cios
‚îÇ   ‚îú‚îÄ‚îÄ get_total_tickets_count()  # L√≥gica de neg√≥cios
‚îÇ   ‚îî‚îÄ‚îÄ get_metrics_gerais()       # Endpoint + l√≥gica
```

**Problemas:**
- ‚ùå L√≥gica misturada com API
- ‚ùå Dif√≠cil de testar isoladamente
- ‚ùå C√≥digo duplicado (get_count_only)
- ‚ùå Viola√ß√£o do princ√≠pio de responsabilidade √∫nica

### Depois da Refatora√ß√£o

**Estrutura:**
```
backend/
‚îú‚îÄ‚îÄ backend.py (~280 linhas)
‚îÇ   ‚îî‚îÄ‚îÄ get_metrics_gerais()       # Apenas endpoint
‚îú‚îÄ‚îÄ logic/
‚îÇ   ‚îú‚îÄ‚îÄ ranking_logic.py           # L√≥gica de ranking
‚îÇ   ‚îî‚îÄ‚îÄ metrics_logic.py           # L√≥gica de m√©tricas
‚îÇ       ‚îú‚îÄ‚îÄ get_count_only()
‚îÇ       ‚îî‚îÄ‚îÄ generate_general_metrics()
```

**Benef√≠cios:**
- ‚úÖ Separa√ß√£o clara de responsabilidades
- ‚úÖ C√≥digo test√°vel isoladamente
- ‚úÖ Padr√£o consistente com ranking
- ‚úÖ Facilita manuten√ß√£o e evolu√ß√£o
- ‚úÖ Reduz tamanho do backend.py

---

## üöÄ Plano de Implementa√ß√£o

### Fase 1: Prepara√ß√£o (5 min)
1. ‚úÖ Criar diret√≥rio `backend/logic/` (se n√£o existir)
2. ‚úÖ Criar arquivo `backend/logic/metrics_logic.py`
3. ‚úÖ Implementar fun√ß√£o `generate_general_metrics()`

### Fase 2: Refatora√ß√£o (10 min)
1. ‚úÖ Modificar `backend/backend.py`:
   - Adicionar import
   - Simplificar endpoint
   - Remover fun√ß√µes obsoletas
2. ‚úÖ Testar funcionamento b√°sico

### Fase 3: Valida√ß√£o (15 min)
1. ‚úÖ Executar testes de funcionalidade
2. ‚úÖ Validar integra√ß√£o com dashboard
3. ‚úÖ Testar cen√°rios de erro
4. ‚úÖ Verificar performance

### Fase 4: Documenta√ß√£o (5 min)
1. ‚úÖ Atualizar este relat√≥rio com resultados
2. ‚úÖ Documentar mudan√ßas no CHANGELOG.md

**Tempo total estimado:** 35 minutos

---

## üìà M√©tricas de Sucesso

### Crit√©rios de Aceita√ß√£o
- ‚úÖ Endpoint `/metrics-gerais` retorna mesmos dados
- ‚úÖ Dashboard carrega m√©tricas automaticamente
- ‚úÖ Performance mantida (tempo < 5s)
- ‚úÖ Tratamento de erros funcional
- ‚úÖ C√≥digo organizado e test√°vel

### Indicadores de Qualidade
- ‚úÖ Redu√ß√£o de ~40 linhas no `backend.py`
- ‚úÖ Separa√ß√£o clara de responsabilidades
- ‚úÖ Padr√£o consistente com `ranking_logic.py`
- ‚úÖ Facilidade para testes unit√°rios
- ‚úÖ Reutiliza√ß√£o da l√≥gica em outros contextos

---

## üîÑ Pr√≥ximos Passos Recomendados

### Imediatos (P√≥s-Refatora√ß√£o)
1. **Implementar cache de 5 minutos** para otimizar performance
2. **Criar testes unit√°rios** para `metrics_logic.py`
3. **Monitorar logs** para identificar poss√≠veis problemas

### Futuras Melhorias
1. **Refatorar `/status-niveis`** seguindo o mesmo padr√£o
2. **Refatorar `/tickets-novos`** seguindo o mesmo padr√£o
3. **Implementar cache centralizado** para todos os m√≥dulos
4. **Adicionar m√©tricas de observabilidade** (tempo de resposta, taxa de erro)

---

## üìã Checklist de Implementa√ß√£o

### Prepara√ß√£o
- [ ] Verificar se diret√≥rio `backend/logic/` existe
- [ ] Criar arquivo `backend/logic/metrics_logic.py`
- [ ] Implementar fun√ß√£o `generate_general_metrics()`
- [ ] Implementar fun√ß√£o auxiliar `get_count_only()`

### Refatora√ß√£o
- [ ] Adicionar import em `backend/backend.py`
- [ ] Simplificar endpoint `/metrics-gerais`
- [ ] Remover fun√ß√£o `get_count_only` obsoleta
- [ ] Remover fun√ß√£o `get_total_tickets_count` obsoleta

### Valida√ß√£o
- [ ] Testar m√≥dulo isoladamente
- [ ] Testar endpoint refatorado
- [ ] Validar integra√ß√£o com dashboard
- [ ] Testar cen√°rios de erro
- [ ] Verificar performance

### Documenta√ß√£o
- [ ] Atualizar CHANGELOG.md
- [ ] Documentar mudan√ßas no README (se necess√°rio)
- [ ] Marcar tarefa como conclu√≠da

---

## üìû Suporte e Contato

Em caso de d√∫vidas ou problemas durante a implementa√ß√£o:
1. Verificar logs do backend (`uvicorn` output)
2. Testar endpoints individualmente com `curl`
3. Validar autentica√ß√£o GLPI
4. Consultar implementa√ß√£o de refer√™ncia em `ranking_logic.py`

---

**Relat√≥rio gerado em:** $(Get-Date -Format "dd/MM/yyyy HH:mm:ss")  
**Vers√£o:** 1.0  
**Status:** Pronto para implementa√ß√£o